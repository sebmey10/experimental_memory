# receiver.py
from fastapi import FastAPI, Request, Response, status
from fastapi.responses import JSONResponse
import json
import logging
from datetime import datetime

logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s [%(levelname)s] %(message)s"
)
logger = logging.getLogger(__name__)

app = FastAPI(title="Zabbix Connector Receiver")


def parse_ndjson(raw_body: bytes) -> list[dict]:
    """
    Zabbix sends NDJSON: one JSON object per line.
    Like reading a stack of postcards — one at a time.
    """
    results = []
    for line in raw_body.decode("utf-8").splitlines():
        line = line.strip()
        if line:
            try:
                results.append(json.loads(line))
            except json.JSONDecodeError as e:
                logger.warning(f"Skipping malformed line: {e} | line: {line[:80]}")
    return results


def process_event(event: dict):
    """
    Handle a single Zabbix event (e.g. tagged ONT trap).
    Extend this with your own logic — RabbitMQ publish, DB write, alert, etc.
    """
    tags = {t["tag"]: t.get("value", "") for t in event.get("tags", [])}
    hosts = [h.get("name", h.get("host", "")) for h in event.get("hosts", [])]
    
    logger.info(
        f"EVENT | id={event.get('eventid')} "
        f"name='{event.get('name')}' "
        f"severity={event.get('severity')} "
        f"hosts={hosts} "
        f"tags={tags} "
        f"clock={event.get('clock')}"
    )
    
    # Example: filter specifically for ONT-tagged traps
    if "ont" in tags or any("ont" in k.lower() for k in tags):
        logger.info(f"  --> ONT trap detected! tags={tags}")
        # TODO: forward to RabbitMQ, write to DB, trigger alert, etc.


def process_history(item: dict):
    """Handle a single Zabbix history/item value."""
    item_tags = {t["tag"]: t.get("value", "") for t in item.get("item_tags", [])}
    logger.info(
        f"HISTORY | itemid={item.get('itemid')} "
        f"name='{item.get('name')}' "
        f"value={item.get('value')} "
        f"host={item.get('host', {}).get('host')} "
        f"tags={item_tags}"
    )


# --- Zabbix POSTs to these two endpoints ---

@app.post("/v1/events", status_code=status.HTTP_200_OK)
async def receive_events(request: Request):
    """
    Receives tagged ONT trap events from Zabbix connector.
    Content-Type: application/x-ndjson
    """
    body = await request.body()
    
    if not body:
        logger.warning("Received empty body on /v1/events")
        return Response(status_code=204)
    
    events = parse_ndjson(body)
    logger.info(f"Received {len(events)} event(s) on /v1/events")
    
    for event in events:
        process_event(event)
    
    return {"received": len(events)}


@app.post("/v1/history", status_code=status.HTTP_200_OK)
async def receive_history(request: Request):
    """
    Receives item value history from Zabbix connector.
    Content-Type: application/x-ndjson
    """
    body = await request.body()
    
    if not body:
        return Response(status_code=204)
    
    items = parse_ndjson(body)
    logger.info(f"Received {len(items)} item value(s) on /v1/history")
    
    for item in items:
        process_history(item)
    
    return {"received": len(items)}


@app.get("/health")
async def health():
    return {"status": "ok", "time": datetime.utcnow().isoformat()}