1. Trap is sent. Trap table updates, script begins. ONT table is queried, along with TRAP table. Join the ONT table and TRAP table ON serial_number.
    - SELECT traps.serial_number, traps.timestamp
      FROM traps
      JOIN onts ON traps.serial_number = onts.serial_number
      WHERE traps.processed = FALSE;
    - Matching ONTs set to an out status and given a lock_id.

2. Level 0 checks start happening. Query the DB using the ONT's tap to determine an outage. If two or more ONTs under a tap are set to an out status within 30 seconds of each other it's a level 0 outage.
    - SELECT onts.tap_id, MIN(onts.status_changed_at) AS first_out, MAX(onts.status_changed_at) AS last_out
      FROM onts
      WHERE onts.tap_id = :tap_id
        AND onts.status = 'out'
      GROUP BY onts.tap_id
      HAVING COUNT(*) >= 2
         AND MAX(onts.status_changed_at) - MIN(onts.status_changed_at) <= INTERVAL '30 seconds';
    - Set lock_id on tap if condition is met, cascade to ONTs.

3. Level 1 checks start happening. Query the DB to see if two or more taps under a parent tap are experiencing a level 0 outage within 30 seconds of each other.
    - SELECT taps.parent_tap_id, MIN(taps.locked_at) AS first_lock, MAX(taps.locked_at) AS last_lock
      FROM taps
      WHERE taps.parent_tap_id = :parent_tap_id
        AND taps.lock_id IS NOT NULL
      GROUP BY taps.parent_tap_id
      HAVING COUNT(*) >= 2
         AND MAX(taps.locked_at) - MIN(taps.locked_at) <= INTERVAL '30 seconds';
    - Set lock_id on parent tap and cascade to the child taps, replacing potential original lock_id that has been set.

4. Level 2 checks start happening. Query the DB to see if two or more parent taps under a strand are experiencing a level 1 outage within 30 seconds of each other.
    - SELECT taps.strand_id, MIN(taps.locked_at) AS first_lock, MAX(taps.locked_at) AS last_lock
      FROM taps
      WHERE taps.strand_id = :strand_id
        AND taps.is_parent = TRUE
        AND taps.lock_id IS NOT NULL
      GROUP BY taps.strand_id
      HAVING COUNT(*) >= 2
         AND MAX(taps.locked_at) - MIN(taps.locked_at) <= INTERVAL '30 seconds';
    - Set lock on strand, cascade lock_id all the way down the chain.
